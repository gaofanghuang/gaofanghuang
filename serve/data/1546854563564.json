{"id":"1546854563564","title":"Blog3.0改版记录\n","summary":"新年新版本！\n","tags":["改版","blog","Vue","Koa"],"content":"# Blog3.0改版记录\n\n> 新年新版本！\n\n这次使用了koa2重构后端程序，并且增加了本地上传图片的功能。\n\n😱之前用七牛外链的图片全部挂了，还是本地存图保险一些。那些挂掉的图片，改起来工作量太大了，等有空再慢慢想办法找回吧😓。\n\n## 改版需求\n\n这是之前 1.0, 2.0的改版记录:\n\n1. 1.0 https://huanggaofang.com/blog/detail/1515849780154\n\n2. 2.0 https://huanggaofang.com/blog/detail/1526809465617\n\n---\n\n3.0 需求：\n\n1. 本地存图，不在使用第三方图床了 √\n\n2. 进一步整合编辑与查看功能 √\n\n3. 把主仓库与Blog仓库合并 √\n\n4. 更精简的代码 √\n\n5. 重新设计一套完整的图标\n\n6. Markdown解析样式优化\n\n7. 自动保存编辑框的内容到本地\n\n--- \n\n## 改版说明\n\n### 旧版截图\n\n![1547547161389.png](http://localhost:9000/uploads/1547547161389.png)\n\n![1547547177270.png](http://localhost:9000/uploads/1547547177270.png)\n\n因为图床挂了，找不到更多以前的截图了。大概就是这种稍微绚丽厚重一点的风格吧。\n\n### 新版截图\n\n*编辑页*：\n\nPC端：\n\n![1547546138450.png](http://localhost:9000/uploads/1547546138450.png)\n\n\n移动端：\n\n![1547546226609.png](http://localhost:9000/uploads/1547546226609.png)\n\n\n*列表页*：\n\nPC端:\n\n![1547546514546.png](http://localhost:9000/uploads/1547546514546.png)\n\n![1547546533287.png](http://localhost:9000/uploads/1547546533287.png)\n\n移动端：\n\n![1547546844948.png](http://localhost:9000/uploads/1547546844948.png)\n\n![1547546856315.png](http://localhost:9000/uploads/1547546856315.png)\n\n\n*详情页*：\n\nPC端：\n\n![1547546639604.png](http://localhost:9000/uploads/1547546639604.png)\n\n![1547546658890.png](http://localhost:9000/uploads/1547546658890.png)\n\n移动端：\n\n![1547546682034.png](http://localhost:9000/uploads/1547546682034.png)\n\n![1547546693425.png](http://localhost:9000/uploads/1547546693425.png)\n\n![1547546704123.png](http://localhost:9000/uploads/1547546704123.png)\n\n\n### 设计理念\n\n2018年发生了许多事情，换了一个城市，换了一个公司。 \n\n年中的时候从广州搬到了深圳，开发的项目也从电商换成了社交。\n\n认识了一些新朋友，也与一些人不再联系。\n\n今年希望好好充实自己，去掉一些多余的装饰，工作与生活只需要简单、实用与舒适。\n\n因此，这次改版，我希望界面能更清爽、交互体验更好。\n\n\n### 技术架构\n\nvue + koa2\n\n\n## 遇到的坑\n\n### 原生实现本地JSON文件的读写\n\n不知是不是换成koa框架开发的原因，lowdb之前在2.0的时候还用得好好的，到3.0开发的时候，删除api就一直无效，使用 `read()`刷新缓存也还是不行，无解了。\n\n因此还是自己实现了文件的读写，好在数据格式比较简单，实现起来也容易。\n\n以下是代码：\n\n```\nconst fs = require('fs');\n\n// 读取文件\nfunction getFile(path = 'list') {\n    let filePath = 'data/' + path + '.json'\n    return JSON.parse(fs.readFileSync(filePath))\n}\n\n// 写入文件\nfunction postFile(path = 'list', req) {\n    let filePath = 'data/' + path + '.json';\n    fs.writeFileSync(filePath, JSON.stringify(req));\n}\n\n// 删除文件\nfunction deleteFile(id) {\n    let filePath = 'data/' + id + '.json';\n    fs.unlinkSync(filePath);\n}\n```\n\n\n### 第三方图床与本地存图的选择\n\n七牛的外链图全挂了，进后台都下载不了, 哭死……\n\n用了阿里云OSS有怕不小心流量过大消费不起，战战兢兢……\n\n最后还是决定自己实现本地存图功能，也许以后有闲钱可以买个服务器跑Node了呢🤣\n\n```\n// 上传图片\n\nconst upload = async (ctx, next) => {\n    const req = ctx.request.body;\n    ctx.status = 200;\n    let base64Data = req.base64.replace(/^data:image\\/\\w+;base64,/, \"\");\n    let dataBuffer = new Buffer(base64Data, 'base64');\n    let fileType = req.base64.match(/^data:image\\/\\w+;/)[0];\n    fileType = fileType.split('/')[1].replace(';', '');\n    let filleName = Date.now();\n    let filePath = 'public/uploads/' + filleName + '.' + fileType\n    fs.writeFile(filePath, dataBuffer, function (err) {\n        console.log(err);\n    });\n    ctx.body = {\n        message: \"上传成功\",\n        id: filleName + '.' + fileType\n    }\n}\n```\n\n## 待优化的功能\n\n1. 点击图片查看大图\n\n\n\n","lasttime":1547547943013}